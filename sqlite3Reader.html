
<!doctype html>
<html>
<head>
  <meta charset="utf8">
  <title>Favorite Subreddits</title>
  <script src="http://kripken.github.io/sql.js/GUI/codemirror/lib/codemirror.js"></script>
</head>
<body>

	<h1>My Most Viewed Subreddits</h1>


    <textarea id="commands"></textarea>

<button id="execute" style="visibility:hidden;" class="button">Execute</button>
<label class="button">Load your Chrome SQLite database file: <input type='file' id='dbfile' ></label>

<div id="error" class="error"></div>

<div id="output"></div>


<script src="sql.js"></script>

<footer>
Original work by kripken (<a href='https://github.com/kripken/sql.js'>sql.js</a>).
C to Javascript compiler by kripken (<a href='https://github.com/kripken/emscripten'>emscripten</a>).
Project now maintained by <a href='https://github.com/lovasoa'>lovasoa</a>
</footer>

<script type='text/javascript'>
  
  var execBtn = document.getElementById("execute");
var outputElm = document.getElementById('output');
var errorElm = document.getElementById('error');
var commandsElm = document.getElementById('commands');
var dbFileElm = document.getElementById('dbfile');
var savedbElm = document.getElementById('savedb');

// Start the worker in which sql.js will run
var worker = new Worker("worker.sql.js");
worker.onerror = error;

// Open a database
worker.postMessage({action:'open'});

// Connect to the HTML element we 'print' to
function print(text) {
    outputElm.innerHTML = text.replace(/\n/g, '<br>');
}
function error(e) {
  console.log(e);
	errorElm.style.height = '2em';
	errorElm.textContent = e.message;
}

function noerror() {
		errorElm.style.height = '0';
}

// Run a command in the database
function execute(commands) {
	tic();
	worker.onmessage = function(event) {
		var results = event.data.results;
		toc("Executing SQL");

		tic();
		outputElm.innerHTML = "";
		
		var tallies = new Object();
		
		re = /https?:\/\/(www.reddit.com\/r\/[^\/#]*).*/
		results[0].values = results[0].values.filter(function(entry) {
			var match =  re.exec(entry[0]);
			if(match)
				if(tallies[match[1]])
					tallies[match[1]] += entry[1]
				else
					tallies[match[1]] = entry[1]
					
			return match;
		});
		
		talliesSorted = [];//copy data to array for sorting
		for(var key in tallies){
			talliesSorted.push({"subreddit":key,"count":tallies[key]});
		}
		
		talliesSorted.sort(function(a,b){
			return b["count"] - a["count"];
		})
		
		console.log(talliesSorted);
		
		var tbl  = document.createElement('table');
	
		for (var i=0; i<talliesSorted.length; i++) {
			var tr = tbl.insertRow();
			var td1 = tr.insertCell();
			var td2 = tr.insertCell();
			td1.innerHTML =  talliesSorted[i]["subreddit"];
			td2.innerHTML =  talliesSorted[i]["count"];
		}
		outputElm.appendChild(tbl);
		toc("Displaying results");
	}
	worker.postMessage({action:'exec', sql:commands});
	outputElm.textContent = "Fetching results...";
}


// Execute the commands when the button is clicked
function execEditorContents () {
	noerror()
	execute (editor.getValue() + ';');
}
execBtn.addEventListener("click", execEditorContents, true);

// Performance measurement functions
var tictime;
if (!window.performance || !performance.now) {window.performance = {now:Date.now}}
function tic () {tictime = performance.now()}
function toc(msg) {
	var dt = performance.now()-tictime;
	console.log((msg||'toc') + ": " + dt + "ms");
}

// Add syntax highlihjting to the textarea
var editor = CodeMirror.fromTextArea(commandsElm, {
    mode: 'text/x-mysql',
    viewportMargin: Infinity,
    indentWithTabs: true,
    smartIndent: true,
    lineNumbers: true,
    matchBrackets : true,
    autofocus: true,
		extraKeys: {
			"Ctrl-Enter": execEditorContents,
			"Ctrl-S": savedb,
		}
});

// Load a db from a file
dbFileElm.onchange = function() {
	var f = dbFileElm.files[0];
	var r = new FileReader();
	r.onload = function() {
		worker.onmessage = function () {
			toc("Loading database from file");
			// Show the schema of the loaded database
			editor.setValue("SELECT url, visit_count from urls;");
			execEditorContents();
		};
		tic();
		try {
			worker.postMessage({action:'open',buffer:r.result}, [r.result]);
		}
		catch(exception) {
			worker.postMessage({action:'open',buffer:r.result});
		}
	}
	r.readAsArrayBuffer(f);
}

// Save the db to a file
function savedb () {
	worker.onmessage = function(event) {
		toc("Exporting the database");
		var arraybuff = event.data.buffer;
		var blob = new Blob([arraybuff]);
		var url = window.URL.createObjectURL(blob);
		window.location = url;
	};
	tic();
	worker.postMessage({action:'export'});
}
savedbElm.addEventListener("click", savedb, true);

</script>
</body>
</html>



